name: Bybit Price Alerter

# Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ø¤Ù‚Øª: Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch: # ÙŠØ³Ù…Ø­ Ù„Ùƒ Ø¨ØªØ´ØºÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹

jobs:
  check-prices:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Run Bybit Check
        # Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªØ´ØºÙŠÙ„ Ø³ÙƒØ±Ø¨Øª Ø¨Ø§ÙŠØ«ÙˆÙ† ØµØºÙŠØ± Ù‡Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©
        # Ù‡Ø°Ø§ Ø§Ù„Ø³ÙƒØ±Ø¨Øª ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø³Ø±Ø§Ø± (Secrets) Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªÙ„ÙŠØ¬Ø±Ø§Ù…
        run: |
          import requests
          import os
          import json

          API_URL = "https://api.bybit.com/v5/market/tickers?category=spot"
          TARGET_PERCENT = 0.05  # 5% (ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª)
          
          # Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø°ÙŠ ÙŠØ®Ø²Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù‡Ø§
          # Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙŠØªÙ… Ø­ÙØ¸Ù‡ Ø¨ÙŠÙ† Ø§Ù„ØªØ´ØºÙŠÙ„Ø§Øª
          STATE_FILE = 'alerted_symbols.json'

          # Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø±Ø§Ø± Ù…Ù† GitHub
          BOT_TOKEN = os.environ['TELEGRAM_BOT_TOKEN']
          CHAT_ID = os.environ['TELEGRAM_CHAT_ID']

          def load_alerted_symbols():
              if not os.path.exists(STATE_FILE):
                  return set()
              try:
                  with open(STATE_FILE, 'r') as f:
                      return set(json.load(f))
              except (IOError, json.JSONDecodeError):
                  return set()

          def save_alerted_symbols(symbols_set):
              try:
                  with open(STATE_FILE, 'w') as f:
                      json.dump(list(symbols_set), f)
              except IOError:
                  pass # Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙØ¹Ù„ Ø§Ù„ÙƒØ«ÙŠØ± ÙÙŠ Ø¨ÙŠØ¦Ø© 'serverless'

          def send_telegram_message(message):
              url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
              payload = {'chat_id': CHAT_ID, 'text': message, 'parse_mode': 'Markdown'}
              try:
                  requests.post(url, json=payload, timeout=5)
                  print(f"Sent message: {message}")
              except Exception as e:
                  print(f"Failed to send Telegram message: {e}")

          # --- Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ---
          alerted_symbols = load_alerted_symbols()
          new_alerts_found = False
          
          try:
              response = requests.get(API_URL, timeout=10)
              data = response.json()
              
              if data.get('retCode') == 0:
                  for ticker in data.get('result', {}).get('list', []):
                      symbol = ticker.get('symbol', '')
                      if not symbol.endswith('USDT'):
                          continue
                      
                      try:
                          change_percent = float(ticker.get('price24hPcnt', '0'))
                      except ValueError:
                          continue

                      if change_percent >= TARGET_PERCENT:
                          if symbol not in alerted_symbols:
                              percent_formatted = change_percent * 100
                              message = f"ğŸš€ *ØªÙ†Ø¨ÙŠÙ‡ Bybit* ğŸš€\n\nØ¹Ù…Ù„Ø©: *{symbol}*\nØ§Ø±ØªÙØ¹Øª Ø¨Ù†Ø³Ø¨Ø©: *{percent_formatted:.2f}%*\nØ§Ù„Ø³Ø¹Ø±: {ticker.get('lastPrice', 'N/A')}"
                              send_telegram_message(message)
                              alerted_symbols.add(symbol)
                              new_alerts_found = True
              else:
                  print(f"API Error: {data.get('retMsg')}")

          except Exception as e:
              print(f"Script Error: {e}")

          if new_alerts_found:
              save_alerted_symbols(alerted_symbols)
              print("Saved updated symbols list.")
          else:
              print("No new symbols found.")

        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      - name: Commit state file
        # Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© Ù…Ù‡Ù…Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…Ù„Ø§Øª
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add alerted_symbols.json
          # Commit ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ±Ø§Øª
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update alerted symbols state" && git push)
